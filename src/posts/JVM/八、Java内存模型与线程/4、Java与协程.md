---
<!--cover: /assets/images/cover2.jpg-->
icon: pen-to-square
date: 2024-11-06
category:
  - JVM
  - Java内存模型与线程
tag:
  - 线程缺陷
  - 协程
star: true
ticky: true
---
# 8.4 Java与协程

## 一、线程的缺陷

在理解虚拟线程前，我们先回顾一下线程的特点：

- 线程是由操作系统创建并调度的资源；
- 线程切换会耗费大量CPU时间；
- 一个系统能同时调度的线程数量是有限的，通常在几百至几千级别。

因此，我们说线程是一种重量级资源。在服务器端，对用户请求，通常都实现为一个线程处理一个请求。由于用户的请求数往往远超操作系统能同时调度的线程数量，所以通常使用线程池来尽量减少频繁创建和销毁线程的成本

对于需要处理大量IO请求的任务来说，使用线程是低效的，因为一旦读写IO，线程就必须进入等待状态，直到IO数据返回。常见的IO操作包括：

- 读写文件；
- 读写网络，例如HTTP请求；
- 读写数据库，本质上是通过JDBC实现网络调用。

## 二、协程

- **协程**是一种比线程更加轻量级的存在，一个进程可以拥有多个线程，一个线程也可以拥有多个协程。
- 协程不是被操作系统内核所管理，而完全是由程序所控制（也就是在用户态执行）。这样带来的好处就是性能得到了很大的提升，不会像线程那样需要上下文切换来消耗资源，因此**协程的开销远远小于线程的开销**。

**优点：**协程比传统内核线程要轻量得多

**缺点：**程序实现内容更多比如调用栈、调度器。

由于协程会完整地做调用栈的保护、恢复工作，所以今天也被称为“有栈线程”。对于有栈线程，Java有一种特例实现名为纤程。

纤程并发代码分为两部分：

- 执行过程。维护执行现场，保护、恢复上下文状态
- 调度器。负责编排所有要执行的代码的顺序

## 三、JDK19协程

JDK19（非LTS版本）正式引入协程。

为了能高效执行IO密集型任务，Java从19开始引入了虚拟线程。虚拟线程的接口和普通线程是一样的，但是执行方式不一样。虚拟线程不是由操作系统调度，而是由普通线程调度，即成百上千个虚拟线程可以由一个普通线程调度。任何时刻，只能执行一个虚拟线程，但是，一旦该虚拟线程执行一个IO操作进入等待时，它会被立刻“挂起”，然后执行下一个虚拟线程。什么时候IO数据返回了，这个挂起的虚拟线程才会被再次调度。因此，若干个虚拟线程可以在一个普通线程中交替运行

- Java 19引入的虚拟线程是为了解决IO密集型任务的吞吐量，它可以高效通过少数线程去调度大量虚拟线程；

- 虚拟线程在执行到IO操作或Blocking操作时，会自动切换到其他虚拟线程执行，从而避免当前线程等待，能最大化线程的执行效率；

- 虚拟线程使用普通线程相同的接口，最大的好处是无需修改任何代码，就可以将现有的IO操作异步化获得更大的吞吐能力。

- 计算密集型任务不应使用虚拟线程，只能通过增加CPU核心解决，或者利用分布式计算资源。











